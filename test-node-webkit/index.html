<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hello world</title>
  <link rel="stylesheet" href="style.css">
  <script src="js/host.json"></script>
</head>
<body onload="/*process.mainModule.exports.callback();*/">
  <div class="toolbar" id="toolbar"></div>
  <ul class="system_mutual">
    <li class="refresh2" title="强制刷新"><i></i></li>
    <li class="refresh" title="刷新"><i></i></li>
    <li class="minimum" id="minimum" title="最小化"></li>
    <li class="maximum" id='maximum' title="最大化"></li>
    <li id="close" class="close" title="关闭"></li>
  </ul>
  <div class="wraper" id="devtools">
    <h1>Hello World!0</h1>
    <input type="button" value="截图" onclick = "oMenu.takeSnapshot('images/','aa','png')">
  </div>
  <script>
var oMenu = {
  "isMaxScreen":false,
  "getOne":function(p,str){
    return p.querySelector(str);
  },
  "getAll":function(p,str){
    return p.querySelectorAll(str);
  },
  "minFn":function(){
    win.hide();
    var tray = new gui.Tray({title:"tray",icon:"logo.png"});
    tray.tooltip = "打开软件";
    // 设置右键菜单
    tray.menu = trayMenu;
    //点击打开软件
    tray.on("click",function(){
      this.remove();
      tray = null;
      win.show();
      win.focus();
      isShowWindow = true;
    });
  },
  "maxFn":function(){
    if(!oMenu.isMaxScreen){
      win.maximize();
    }else{
      win.unmaximize();
    }
    oMenu.isMaxScreen = !oMenu.isMaxScreen;
  },
  // 截图函数
  takeSnapshot:function(path,name,type){
    win.capturePage(function (img) {
      var base64Data = img.replace(/^data:image\/(png|jpg|jpeg);base64,/, "");
      require("fs").writeFile(path+name+"."+type, base64Data, 'base64', function (err) {
       console.log(err);
      });
    }, type);
  },
  // 清除非当前项
  removeNotCurent:function(items,current){
    var len = items.length;
    for(var i=0;i<len;i++){
      items[i].checked = false;
    }
    current.checked = true;
  }
}

//引入nw.gui模块
var gui = require("nw.gui");

// 引入文件系统模块
var fs = require("fs");

//获取当前窗口
var win = gui.Window.get();

var oMinimum = oMenu.getOne(document,".minimum"),
  oMaximum = oMenu.getOne(document,".maximum"),
  oClose = oMenu.getOne(document,".close"),
  oRefreah = oMenu.getOne(document,".refresh"),
  oRefreah2 = oMenu.getOne(document,".refresh2"),
  h1 = oMenu.getOne(document,"h1");

// 刷新窗口
oRefreah.addEventListener("click",function(){
  win.reload();
});

// 强刷
oRefreah2.addEventListener("click",function(){
  win.reloadIgnoringCache();
});

//窗口最小化
oMinimum.addEventListener("click",function(){
  win.minimize();
});
// 侦听窗口最小化
win.on("minimize",oMenu.minFn);

//窗口最大化
oMaximum.addEventListener("click",oMenu.maxFn);

// 关闭窗口
oClose.addEventListener("click",function(){
  win.close();
});


//创建菜单
// 创建window菜单
var topMenubar = new gui.Menu({ type: 'menubar' });
var rightHand = new gui.Menu();
rightHand.append(new gui.MenuItem({
  label:"复制",
  type:"checkbox"/*,
  click:function(){
    alert("逗你呢");
  }*/
}));
// 菜单添加分割线
rightHand.append(new gui.MenuItem({
  type:"separator"
}));
rightHand.append(new gui.MenuItem({
  label:"图标",
  icon:"logo.png"
}));
rightHand.append(new gui.MenuItem({
  type:"separator"
}));
topMenubar.append(new gui.MenuItem({label:"菜单哈",submenu:rightHand}));
win.menu = topMenubar;
// 创建content菜单

document.addEventListener("contextmenu",function(ev){
  ev.preventDefault();
  // 设置右键菜单位置
  rightHand.popup(ev.x,ev.y);
  // 或者ev.clientX
  // rightHand.popup(ev.x,ev.y);
  return false;
});

var host = "C:\\Windows\\System32\\drivers\\etc\\hosts";
var trayMenu = new gui.Menu();
var aTrayMenu = ["local","ui","test","pro"];
trayLength = aTrayMenu.length;
for(var i=0;i<trayLength;i++){
  trayMenu.append(new gui.MenuItem({
    label:aTrayMenu[i],
    type:"checkbox",
    click:function(ev){
      oMenu.removeNotCurent(trayMenu.items,this);
      this.StaticSelectedStyle="background:red";
      var str = oHost[this.label];
      str = str.replace(/\s*\n\s*/g,"\n");
      // nodejs读取文件
      fs.readFile(host,'utf8',function(err, data){
        if(err){
          return console.log(err);
        }
        // nodejs写入文件
        fs.writeFile(host,str,function(err){
          if(err){
            return console.log(err);
          }
        });
      });
    }
  }));
}

  </script>
</body>
</html>